# �������ϵͳ�����������޸�����

## �������
�û�����ǰ���Ǳ�����ʾ"?"���������Ϊ��
1. ֧������ռ�ȵı�״ͼ��ʾ"?"
2. ���롢֧�����������ֵ��ʾΪ"?"
3. ͼ���޷�������Ⱦ

## ϵͳ�ܹ�����

### ����ջ
- **���**: Node.js + Express + SQL.js (WebAssembly SQLite)
- **ǰ��**: ԭ��JavaScript + Chart.js + Bootstrap
- **���ݿ�**: SQLite via SQL.js���ڴ����ݿ⣬���ڳ־û����ļ���
- **��֤**: JWT����

### �����ļ��ṹ
```
������ server.js              # ���������ļ�
������ config/database.js     # ���ݿ�����
������ src/routes/analytics.js # ���ݷ���API
������ src/repositories/      # ���ݷ��ʲ�
������ public/js/app.js       # ǰ�����߼�
������ database/finance.db    # SQLite���ݿ��ļ�
```

## ������Ͻ��

### 1. �ļ���������
**����**: `src/routes/analytics.js` �� `src/repositories/TransactionRepository.js` ���ļ��е������ַ���ʾΪ���루��"???????��??"����

**Ӱ��**: ���ܵ��´����߼�����ά����������ֱ��Ӱ������ʱ���ܡ�

**���ȼ�**: �ͣ��ɺ����޸���

### 2. Analytics API �߼�ȱ��

#### ����A: ͬ��/�첽���ò�һ��
**�ļ�**: `src/routes/analytics.js:34-35`
```javascript
const income = transactionRepository.sumAmountByUserAndType(req.user.id, monthStart, monthEnd, 'income');
const expense = transactionRepository.sumAmountByUserAndType(req.user.id, monthStart, monthEnd, 'expense');
```
**����**: `TransactionRepository.sumAmountByUserAndType()` ��ͬ������������ `row.total`������API·���� `async` ���������ֻ��ÿ��ܵ��´�������һ�¡�

#### ����B: SQL��ѯ�߼�ȱ��
**�ļ�**: `src/routes/analytics.js:87-93`
```sql
SELECT COALESCE(SUM(amount), 0) as total
FROM transactions 
WHERE user_id = ? AND category_id = ? AND date BETWEEN ? AND ?
```
**����**: 
1. ���׿���û�з��ࣨ`category_id` Ϊ NULL������ʱ��ѯ���� `category_id = ?` ����ƥ��
2. û����֤�����Ƿ����ڵ�ǰ�û�

#### ����C: Ĭ������Ӳ����
**�ļ�**: `src/routes/analytics.js:118-125`
```javascript
if (categories.length === 0) {
  categories = [
    { name: '????', amount: 1200, percentage: 30, color: '#FF6384' },
    // ... Ӳ��������
  ];
}
```
**����**: ���û�û������ʱ����Ӳ������������ݣ�����ǰ��ͼ����ʾ�쳣��

### 3. ���ݿ�����ȱʧ
**����**: ���ܵ�ԭ�������
1. ���û�û�д����κν��׼�¼
2. ���׼�¼û�й�������
3. �������ȱ���û��ķ��ඨ��

### 4. ǰ�˴���������
**�ļ�**: `public/js/app.js:166-210`
**����**: 
1. `loadDashboard()` ����û�д���API������Ӧ
2. �� `monthlyData.monthly` Ϊ��ʱ��`find()` ���� `undefined`
3. `renderCategoryChart()` �Կ�����Ĵ������ܲ�����׳

## �޸�����

### �����ȼ��޸���ֱ��Ӱ�칦�ܣ�

#### �޸�1: ����Analytics API��ѯ�߼�
**Ŀ��**: ȷ����ȷ�������ռ��

**�޸��ļ�**: `src/routes/analytics.js`
1. �޸�SQL��ѯ������ `category_id` Ϊ NULL �����
2. �����û�Ȩ����֤
3. �Ƴ�Ӳ�����Ĭ������
4. ȷ�����ص����ݸ�ʽ����ǰ������

#### �޸�2: ��ǿǰ�˴�����
**Ŀ��**: ���Ŵ������������

**�޸��ļ�**: `public/js/app.js`
1. ����������֤��Ĭ��ֵ
2. �Ľ�ͼ����Ⱦ�Ŀ����ݴ���
3. ���Ӹ���ϸ�Ĵ�����־

#### �޸�3: ȷ������һ����
**Ŀ��**: Ϊ���û��ṩ��ʼ���ݻ�������ָ��

**����**:
1. ����Ĭ�Ϸ��ࣨ����û�û�з��ࣩ
2. �ṩʾ����������
3. �Ľ�UI�����û�������һ�ʽ���

### �����ȼ��޸�������������

#### �޸�4: ͳһͬ��/�첽ģʽ
**Ŀ��**: ��ȷ��������Լ��

**����**:
1. ������repository������ȷ���Ϊͬ������ΪSQL.js��ͬ���ģ�
2. �Ƴ�����Ҫ�� `async/await`

#### �޸�5: �޸��ļ�����
**Ŀ��**: ȷ������ɶ��ԺͿ�ά����

**����**: ���±����ļ�ΪUTF-8����

### �����ȼ��޸����Ż���

#### �޸�6: ����������֤
**Ŀ��**: ��ֹ��Ч���ݵ��µ�����

#### �޸�7: �Ľ���־�͵�����Ϣ
**Ŀ��**: ���������Ų�

## ʵʩ����

### �׶�1: �����޸���1-2Сʱ��
1. �޸�Analytics API�ĺ��Ĳ�ѯ�߼�
2. ��ǿǰ�˴�����
3. ��֤�޸�Ч��

### �׶�2: ���������Ľ���2-3Сʱ��
1. ͳһͬ��/�첽ģʽ
2. �޸��ļ�����
3. ���ӱ�Ҫ��ע��

### �׶�3: �û������Ż���1-2Сʱ��
1. �Ľ���״̬UI
2. �����û�����
3. �Ż����ݳ�ʼ��

## ��������

### ����1: ���ݿ��ѯ����
**Ӱ��**: �ͣ���������С
**����**: �����ʵ��������Ͳ�ѯ�Ż�

### ����2: ��������
**Ӱ��**: �У�API��Ӧ��ʽ���ܱ仯
**����**: ��������API��Ӧ��ʽ��ֻ������������

### ����3: ǰ��ͼ���������
**Ӱ��**: �ͣ�Chart.js�ȶ��Խϸ�
**����**: ���Ӱ汾�����ͽ�������

## ��֤�ƻ�

1. **��Ԫ����**: Ϊ�޸���API�˵����Ӳ���
2. **���ɲ���**: ģ���û��������ж˵��˲���
3. **�ֶ���֤**: 
   - ��¼ϵͳ
   - ����Ǳ���������ʾ
   - �������ײ���֤ͼ������
   - ���Ա�Ե����������ݡ���Ч���룩

## ��������

1. **��غ���־**: ���ӹؼ���������־��¼
2. **����׷��**: ����Sentry�����ƴ���׷�ٷ���
3. **���ݱ���**: ʵ�����ݿⱸ�ݻ���
4. **�����Ż�**: ���Ƿ�ҳ��ѯ�ͻ������

---
**�������ʱ��**: 2025-12-21 15:18 (UTC+8)
**������**: Roo (Architectģʽ)
**��һ��**: ���û���˴˷�������Ȩ����Codeģʽʵʩ�޸�
