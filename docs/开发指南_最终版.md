# �������ϵͳ - ����ָ��

## ��Ŀ����

�������ϵͳ��һ�����ز���Ĳ���������ߣ����� Node.js + Express + SQLite ��ˣ��Լ� Bootstrap 5 + Chart.js ǰ�ˡ�ϵͳרΪ�����֪ʶ�ѷ����û���ƣ��ṩһ��������ֱ�۽�������������ݷ������ܡ�

### ����Ŀ��
- **����������**��˫�����ã����踴������
- **���ݰ�ȫ**���������ݱ����ڱ��أ��������ƶ�
- **��չ��ǿ**��ģ�黯�ܹ�֧��δ��������չ
- **��ƽ̨����**��Windows 10/11 ϵͳ��������

## ����ջ

### ��˼���
- **����ʱ**��Node.js 18+
- **���**��Express 4.x
- **���ݿ�**��SQLite��ͨ�� SQL.js ���ڴ������У�
- **��֤**��JWT + bcryptjs
- **��������**��dotenv

### ǰ�˼���
- **UI���**��Bootstrap 5
- **ͼ����**��Chart.js 4.x
- **�����߼�**��ԭ�� JavaScript��ES6+��
- **ͼ��**��Font Awesome

### ��������
- **������**��npm
- **�汾����**��Git
- **��������**��VS Code
- **���Թ���**��Chrome DevTools

## ��Ŀ�ṹ

```
g:/Personal test/����Ŀ��Ŀ¼��
������ config/                    # �����ļ�
��   ������ database.js           # ���ݿ��������ã�SQL.js��
��   ������ database-sqljs.js     # SQL.js ԭʼ����
������ database/                 # ���ݿ��ļ�
��   ������ finance.db           # SQLite ���ݿ��ļ�
��   ������ migrations/          # ���ݿ�Ǩ�ƽű�
������ public/                   # ǰ�˾�̬�ļ�
��   ������ index.html           # ��ҳ��
��   ������ css/                 # ��ʽ�ļ�
��   ������ js/                  # JavaScript �ļ�
��   ��   ������ app.js           # ��Ӧ���߼�
��   ��   ������ (����ģ���ļ�)
��   ������ assets/              # ��̬��Դ
������ src/                      # ���Դ����
��   ������ middleware/          # Express �м��
��   ��   ������ auth.js          # JWT ��֤�м��
��   ������ models/              # ����ģ��
��   ��   ������ User.js          # �û�ģ��
��   ��   ������ Transaction.js   # ����ģ��
��   ��   ������ Category.js      # ����ģ��
��   ������ repositories/        # ���ݲֿ��
��   ��   ������ UserRepository.js
��   ��   ������ TransactionRepository.js
��   ��   ������ CategoryRepository.js
��   ������ routes/              # API ·��
��   ��   ������ auth.js          # ��֤·��
��   ��   ������ transactions.js  # ����·��
��   ��   ������ categories.js    # ����·��
��   ��   ������ analytics.js     # ���ݷ���·��
��   ��   ������ users.js         # �û�����·��
��   ������ services/            # ҵ���߼���
��   ��   ������ AuthService.js   # ��֤����
��   ������ utils/               # ���ߺ���
������ scripts/                 # �����ű�
������ plans/                  # ��Ŀ�滮�ĵ�
������ docs/                   # �û��Ϳ����ĵ�
������ node_modules/           # ������
������ .env                    # �������������ύ���汾���ƣ�
������ .env.example           # ��������ʾ��
������ package.json           # ��Ŀ����
������ package-lock.json      # ���������ļ�
������ server.js              # ���������ļ�
������ start.bat              # Windows �����ű���һ��������
������ README.md              # ��Ŀ˵��
������ (���ֲ��Ժ͵����ļ�)
```

## ��������

### 1. ���ƻ��������ļ�
```bash
cp .env.example .env
```

### 2. �༭ `.env` �ļ�
```env
PORT=3000
NODE_ENV=development
DB_PATH=./database/finance.db
JWT_SECRET=your-super-secret-key-at-least-32-characters
BCRYPT_ROUNDS=10
OPEN_BROWSER=true  # �Ƿ��Զ��������
```

### 3. ��������˵��
- `PORT`�������������˿ڣ�Ĭ��Ϊ3000
- `NODE_ENV`�����л�����development/production
- `DB_PATH`��SQLite ���ݿ��ļ�·��
- `JWT_SECRET`��JWT ������Կ������32�ַ�
- `BCRYPT_ROUNDS`�������ϣǿ�ȣ�Ĭ��Ϊ10
- `OPEN_BROWSER`������ʱ�Ƿ��Զ��������

## ���ݿ����

### users �����û�����
| �ֶ� | ���� | ˵�� | Լ�� |
|------|------|------|------|
| id | INTEGER | �û�ID | PRIMARY KEY AUTOINCREMENT |
| username | TEXT | �û��� | UNIQUE, NOT NULL |
| password_hash | TEXT | �����ϣ | NOT NULL |
| email | TEXT | ���� | ��ѡ |
| role | TEXT | ��ɫ | DEFAULT 'user' |
| created_at | DATETIME | ����ʱ�� | DEFAULT CURRENT_TIMESTAMP |

### categories �����������
| �ֶ� | ���� | ˵�� | Լ�� |
|------|------|------|------|
| id | INTEGER | ����ID | PRIMARY KEY AUTOINCREMENT |
| name | TEXT | �������� | NOT NULL |
| type | TEXT | ���� | CHECK (type IN ('income', 'expense')) |
| user_id | INTEGER | �û�ID | REFERENCES users(id) ON DELETE CASCADE |
| color | TEXT | ��ɫ��ʶ | DEFAULT '#007bff' |
| UNIQUE(user_id, name) | | ȷ���û��ڷ���Ψһ | |

### transactions �������ױ���
| �ֶ� | ���� | ˵�� | Լ�� |
|------|------|------|------|
| id | INTEGER | ����ID | PRIMARY KEY AUTOINCREMENT |
| user_id | INTEGER | �û�ID | NOT NULL, REFERENCES users(id) ON DELETE CASCADE |
| category_id | INTEGER | ����ID | REFERENCES categories(id) ON DELETE SET NULL |
| amount | DECIMAL(10,2) | ��� | NOT NULL |
| description | TEXT | ���� | ��ѡ |
| date | DATE | �������� | NOT NULL |
| created_at | DATETIME | ����ʱ�� | DEFAULT CURRENT_TIMESTAMP |

### budgets ����Ԥ��� - Ԥ����
| �ֶ� | ���� | ˵�� | Լ�� |
|------|------|------|------|
| id | INTEGER | Ԥ��ID | PRIMARY KEY AUTOINCREMENT |
| user_id | INTEGER | �û�ID | NOT NULL, REFERENCES users(id) ON DELETE CASCADE |
| category_id | INTEGER | ����ID | REFERENCES categories(id) ON DELETE CASCADE |
| amount | DECIMAL(10,2) | Ԥ���� | NOT NULL |
| month | DATE | Ԥ���·� | NOT NULL |
| created_at | DATETIME | ����ʱ�� | DEFAULT CURRENT_TIMESTAMP |

## API �ӿ��ĵ�

### ��֤ģ��

#### POST /api/auth/register
�û�ע��

**������**��
```json
{
  "username": "testuser",
  "password": "password123",
  "email": "optional@example.com"
}
```

**�ɹ���Ӧ**��201����
```json
{
  "user": {
    "id": 1,
    "username": "testuser",
    "email": null,
    "role": "user",
    "created_at": "2025-12-27 10:00:00"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### POST /api/auth/login
�û���¼

**������**��
```json
{
  "username": "testuser",
  "password": "password123"
}
```

**�ɹ���Ӧ**��200����
```json
{
  "user": { ... },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### ���׹���

#### GET /api/transactions
��ȡ���׼�¼��֧�ַ�ҳ��ɸѡ

**��ѯ����**��
- `page`��ҳ�루Ĭ��1��
- `limit`��ÿҳ������Ĭ��20��
- `startDate`����ʼ���ڣ�YYYY-MM-DD��
- `endDate`���������ڣ�YYYY-MM-DD��
- `categoryId`������ID
- `type`�����ͣ�'income'/'expense'��

#### POST /api/transactions
�������׼�¼

**������**��
```json
{
  "category_id": 1,
  "amount": 100.50,
  "description": "���",
  "date": "2025-12-27"
}
```

#### PUT /api/transactions/:id
���½��׼�¼

#### DELETE /api/transactions/:id
ɾ�����׼�¼

### �������

#### GET /api/categories
��ȡ�û������б�

#### POST /api/categories
��������

**������**��
```json
{
  "name": "����",
  "type": "expense",
  "color": "#FF6384"
}
```

#### PUT /api/categories/:id
���·���

#### DELETE /api/categories/:id
ɾ������

### ���ݷ���

#### GET /api/analytics/monthly
��ȡ�¶�ͳ������

**��ѯ����**��
- `year`����ݣ�Ĭ�ϵ�ǰ��ݣ�
- `months`���·�������Ĭ��12��

**��Ӧ**��
```json
{
  "monthly": [
    {
      "month": "2025-01",
      "income": 5000.00,
      "expense": 3200.00,
      "balance": 1800.00
    },
    // ...
  ]
}
```

#### GET /api/analytics/category
��ȡ����ռ������

**��ѯ����**��
- `type`��'income' �� 'expense'��Ĭ��'expense'��
- `year`�����
- `quarter`�����ȣ�1-4 �� 'all'��
- `month`���·ݣ�1-12 �� 'all'��
- `mode`��ͼ��ģʽ��'pie' �� 'bar'��

#### GET /api/analytics/comparison
��ȡ����֧���Աȷ���

#### GET /api/analytics/trend
��ȡ���Ʒ�������

## �ܹ����

### ���ݿ�� (config/database.js)
ʹ�� SQL.js �ṩ�� WebAssembly SQLite ʵ�֣��ṩ `db` ���� `run`��`get`��`all`��`prepare` �Ȳ����ӿڡ�

**���ķ���**��
- `db.run(sql, params)`��ִ��SQL���
- `db.get(sql, params)`����ȡ������¼
- `db.all(sql, params)`����ȡ���м�¼
- `db.prepare(sql)`��Ԥ����SQL���

### ���ݲֿ�� (repositories)
���� User��Transaction��Category ��ʵ�彨�����ݲֿ⣬ʵ�ֻ����� CRUD �����͸��Ӳ�ѯ��

**���ģʽ**��
- ÿ��ʵ���Ӧһ�� Repository ��
- Repository �����������ݷ����߼�
- Service ��ͨ�� Repository ��������

### ҵ���߼��� (services)
��װҵ���߼����� `AuthService` ���������ϣ��JWT �������ɺ���֤��

**ְ�����**��
- Service ����ҵ����������
- Repository �������ݷ���
- Controller/Route ����HTTP����

### ·�ɲ� (routes)
Express ·��ģ�飬ʹ�� express-validator ���в�����֤������ Service �� Repository��

**�м����**��
1. ������֤��express-validator��
2. ������֤��auth middleware��
3. ҵ����������Service��
4. ��Ӧ����

### �м���� (middleware)
- `auth.js`��JWT ������֤�м����������Ҫ��֤�� API ·��

## ǰ�˼ܹ�

### ҳ��ṹ
- `public/index.html`����ҳ��Ӧ�ã�ʹ�� Bootstrap 5 �� Font Awesome ͼ��
- `public/js/app.js`��ǰ�����߼����������ݼ��ء�ͼ����Ⱦ�ͽ����߼�
- `public/css/`����ʽ�ļ���֧����Ӧʽ���

### ���ݿ��ӻ����
- **Chart.js ����**����̬��Ⱦ����ͼ����״ͼ����ͼ���״�ͼ
- **ͼ������**��ʹ�� `chartInstances` �������ͼ��ʵ���������ڴ�й©
- **��Ӧʽ���**��ͼ������֧����Ӧʽ����Ӧ��ͬ��Ļ��С

### ģ�黯���
1. **�Ǳ���ģ��**��`loadDashboard()` ���غ���Ⱦ�Ǳ���
2. **���׹���ģ��**��`loadTransactions()`��`renderTransactions()` �������׼�¼
3. **�������ģ��**��`loadCategories()`��`renderCategories()` �����������
4. **���ݷ���ģ��**�������ģ�飺
   - �¶�ͳ�ƣ�`loadMonthlyAnalytics()`��`renderMonthlyAnalyticsChart()`
   - ����ռ�ȣ�`loadCategoryAnalytics()`��`renderCategoryAnalyticsChart()`
   - �Աȷ�����`loadComparisonAnalytics()`��`renderComparisonPieChart()`��`renderComparisonBarChart()`
   - ���Ʒ�����`loadTrendAnalytics()`��`renderTrendChart()`

### ״̬����
- **�û���֤״̬**��ͨ�� JWT token �洢�� localStorage
- **���ݻ���**��ʹ�� `categoryCache` ����������ݣ����� API ����
- **ɸѡ״̬**����ģ��ά�����Ե�ɸѡ����״̬

## ����ָ��

### ��������������

```bash
# ��׼����
npm start

# ��ʹ���ṩ�������ű�
start.bat                    # Windowsһ���������Ƽ���
start_debug.bat              # ����ģʽ����
start_simple.bat             # ����ģʽ����
```

### ���� API

ʹ�� curl �� Postman ���в��ԣ�

```bash
# ���ԶԱȷ���API
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" "http://localhost:3000/api/analytics/comparison?year=2025&quarter=1"

# ���Լ���ͳ��API
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" "http://localhost:3000/api/analytics/quarterly?year=2025"
```

### ���Լ���

1. **����̨���**��
   ```javascript
   console.log('�ؼ�ֵ:', value);
   console.table(data); // ������ʽ�������
   ```

2. **��־�ļ�**��
   - �鿴 `debug.log` �ļ���ȡ��ϸ������Ϣ
   - �������Զ���¼��Ҫ�����ʹ���

3. **���������**��
   - ʹ�� Chrome DevTools �鿴�����������Ӧ
   - ��� Console �� Sources ���

4. **ר�ò��Խű�**��
   ```bash
   node test_analytics.js      # �������ݷ���API
   node debug_users.js         # �鿴�û�����
   node check_tables.js        # ������ݿ���ṹ
   ```

### ���ݿ��ѯ

```bash
# �鿴�û�����
node debug_users.js

# ������ݿ��������
node check_tables.js

# �޸�������ɫ
node fix_category_colors.js
```

## ���������Ų�

### 1. ǰ��ͼ����ʾ"?"��հ�

**ԭ��**��Analytics API ���ص����ݸ�ʽ����ȷ����ǰ�� JavaScript ���� API ��Ӧʱ������

**�Ų鲽��**��
1. ��� API ��Ӧ��ʽ�Ƿ����ǰ��Ԥ��
2. ȷ�� `src/routes/analytics.js` �е� SQL ��ѯ��ȷ
3. ǰ�� `public/js/app.js` ����������֤�Ϳ�״̬����

### 2. ���ݿ��ѯ���ؿս��

**ԭ��**��SQL ��ѯ�������󣬻����ݿ�ȷʵû�����ݡ�

**�Ų鲽��**��
1. ��֤ SQL ��ѯ����Ƿ���ȷ
2. ʹ�� `check_tables.js` ������ݿ�����
3. ȷ�ϲ�ѯ�����е� `user_id` �Ƿ���ȷ����

### 3. �ļ���������

**ԭ��**��Դ�ļ�ʹ�÷� UTF-8 ���룬�� VS Code ����ʾΪ���롣

**�������**��
1. ���ؼ��ļ����±���Ϊ UTF-8���� BOM��
2. �� VS Code ���½�״̬���޸��ļ�����
3. ʹ�� `chcp 65001` ���ÿ���̨���루Windows��

### 4. ����������ʧ��

**ԭ��**���˿ڱ�ռ�û�����δ��װ��

**�������**��
1. ���˿� 3000 �Ƿ��ѱ���������ռ��
2. ���� `npm install` ��װ����
3. ��� Node.js �汾�Ƿ����Ҫ��>=18.0.0��

## ��չ����

### �����¹���ģ��

1. �� `src/models/` �ж����µ�����ģ��
2. �� `src/repositories/` ��ʵ�ֶ�Ӧ�� Repository ��
3. �� `src/services/` �б�дҵ���߼�
4. �� `src/routes/` �д��� API ·��
5. ��ǰ�� `public/js/app.js` ��������Ӧ�Ľ����߼�

### ���ݿ�Ǩ��

��ǰʹ�� SQL.js���ڴ� SQLite��������Ǩ�Ƶ���ʵ PostgreSQL ���ݿ⣺
1. �޸� `config/database.js` �е����ݿ����ã�ʹ�� `pg` �ͻ���
2. ���� SQL ��䣬ȷ������ PostgreSQL �﷨
i3. �޸� Repository ��ķ������÷�ʽ
i
### ������������

1. ���� `NODE_ENV=production` ��������
2. ʹ��ǿ��Կ���� `JWT_SECRET`
3. ���÷���������� Nginx����ʹ�ý��̹������ߣ��� PM2��
4. ���ڱ������ݿ��ļ�

## ���ʵ��

### ����淶
- ʼ��ʹ�� async/await �����첽����
- �� Service �㼯�д���ҵ���߼���HTTP ��ֻ�������������Ӧ
i- Ϊ��Ҫ������������ JSDoc ע�ͣ���ߴ���ɶ���
i- ������Ҫȫ�棬Ϊǰ���ṩ�ѺõĴ�����Ϣ
i
### һ����Ҫ��
- ���ִ�����һ�£���ѭ��Ŀ����Լ��
- �����������ݿ��ӻ���ȷ����ʱ�����ɵ� Chart.js ʵ���Ա����ڴ�й©
i- ǰ��ʹ��ģ�黯�ܹ���ƣ�����ȫ�ֱ�����Ⱦ
i
### ��ȫ�Կ���
- �����û����붼������֤������
- ʹ�ò�������ѯ��ֹ SQL ע��
- JWT �������ú����Ĺ���ʱ��
- ����ʹ�� bcrypt ���й�ϣ�洢
i
## 2025-12-22 �޸���¼
i
### ������ɫ��Ĭ��ҳ���޸�
i
#### 1. �����ͼ��ɫ�޸�
**��������**�����ݷ��������У�����ռ�ȸ���Ŀ�ڱ�ͼ�е���ɫ��ͬ�������޷���ʶ��ͬ���ࡣ
i
**����ԭ��**�����ݿ��еķ������ݾ�ʹ��Ĭ����ɫ `#007bff`����ǰ�� `getRandomColor()` �����߼�������ɫ��ͻ��
i
**�������**��
1. �������ݿ��޸��ű� `fix_category_colors.js`��Ϊ����ʹ��Ĭ����ɫ�ķ�������Ψһ���Ӿ������ֵ���ɫ
i2. �޸�ǰ�� `public/js/app.js` �е���ɫ���ɺ������Ľ� `getRandomColor()` ʹ��Ԥ��������ظ���ɫ��
i3. ���� `getColorByCategoryId()` �������ṩ���ڷ���ID��ȷ������ɫ����
i
#### 2. Ĭ��ҳ���ض����޸�
**��������**����������������ת�����ǰ�˻�ˢ��ǰ��ҳ��ʱĬ����ʾ�հ׽��棬��������ҳ��
i
**����ԭ��**��ǰ�� `showMain()` ����ֻ��ʾ���������򣬵�û��Ĭ�ϼ����κξ�������
i
**�������**���޸� `public/js/app.js` �е� `showMain()` ����������ʾ�����ݺ��Զ���ʾ�Ǳ���������ΪĬ����ҳ��
i
#### 3. ����ļ��޸�
- **���ݿ��޸��ű�**��`fix_category_colors.js`
- **��Ͻű�**��`check_categories_fix.js`
- **ǰ�����߼��ļ�**��`public/js/app.js`
- **�û�ָ��**��`docs/user_guide_enhanced.md`
i
## 2025-12-27 һ�������Ż�
i
### start.bat �ش�Ľ�
i
#### ԭ������
- ��Ҫ�û�����ѡ���Ƿ��Զ���������������˿�ռ�ã�
- ������"һ������"��"�û������֪ʶ�ѷ�"��Ҫ��
i
#### �Ľ�����
1. **��ȫ�Զ���**���Ƴ����� `set /p` �û�����
2. **���ܶ˿ڼ��**��
   - ���˿�3000�Ƿ�ռ��
   - �����ռ�ã��ٶ�Ϊ����ϵͳ����������ֱ�Ӵ����������
   - ���δ��ռ�ã������� `OPEN_BROWSER=true` ������������
3. **�������**���Զ���� Node.js �� npm ����
4. **������װ**���Զ���װȱʧ������
5. **���ݿ��ʼ��**���Զ���ʼ��ȱʧ�����ݿ�
i
#### ����Ч��
- �û�ֻ��˫�� `start.bat`
- ���۷������Ƿ��������У������Զ��������ǰ��
- ���û���������ȫ����Ŀ���û���ʹ��ϰ��
i
## δ��ά������
i
### ��ɫϵͳ��չ
i- **��������ɫ��**�������û��Զ��������ɫ
i- **��ɫ�Աȶȼ��**��ȷ�����ɵ���ɫ�����㹻���Ӿ��Աȶ�
i- **ɫä�Ѻ�ģʽ**���ṩרΪɫä�û���Ƶ���ɫ����
i
### ҳ��·����ǿ
i- **�������ʷ֧��**������HTML5 History API
i- **��ǩ�Ѻ�URL**��Ϊ��ͬҳ���������ɿ���ǩ��URLƬ��
i- **ҳ��״̬����**�������û����鿴��ҳ�棬�´ε�¼ʱ�ָ�
i
### �����ά����
i- **ǰ��·���ع�**����������������·�ɿ����ҳ���л�
i- **��ɫ����ģ��**������ɫ��غ�����ȡ������ģ�� `colors.js`
i- **�������Ļ�**������ɫ�塢Ĭ�����õȼ��е������ļ�
i
## ����ָ��
i
��ӭ�ύ Issue �� Pull Request �Ľ���Ŀ��ע�⣺
- ��ѭ���еĴ���ܹ������ģʽ
i- �ṩ�ʵ��Ĳ�������
i- ��������ĵ����û�ָ�ϡ�����ָ�ϣ�
i- �������в��ԣ�ȷ�����ƻ����й���
i
---
i
**�ĵ�����ʱ��**��2025��12��27��  
**�汾**��v2.1��һ�������Ż��棩  
**ά���Ŷ�**���������ϵͳ������
