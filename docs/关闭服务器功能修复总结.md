# �رշ����������޸��ܽ�

## ��������
�û����棺"ǰ�˵���رշ�����û�з�Ӧ��Ԥ���Ч��Ӧ���ǹرշ���������ʾ�û��������Ѿ��رա�"

## �������
ͨ��������鷢���������⣺

### 1. ǰ�˺���ȱʧ
- `public/index.html` ��74�а�����`<a class="dropdown-item" href="#" onclick="shutdownServer()">`
- ����ǰ���ļ� `public/js/app.js` ��δ���� `shutdownServer()` ����
- �����޸��汾 `app-fixed.js` �а����ú�������������������������δ����ҳ�����

### 2. ���·������
- `server.js` �� `/api/shutdown` ·�ɽ���������IP (`127.0.0.1` �� `::1`) ����
- δ������Ŀ��JWT��֤�м��������Ŀ�����ܱ���·�ɵ���֤��ʽ��һ��

### 3. ��������
- `app-fixed.js` �е� `shutdownServer` �����������������ַ��������Ǳ������⵼��

## �������

### ����ѡ�������޸�������һ��
����������ǰ����޸����������ִ���һ���Ժ�����û����顣

### ʵʩ����

#### 1. ǰ���޸� (`public/js/app.js`)
���ļ�ĩβ���������ķ������رչ��ܣ�

```javascript
// ============================================
// �������رչ���
// ============================================

/**
 * �رշ���������
 * ��ʾȷ�϶Ի��򣬴�������ģ̬�򣬷��͹ر����󵽷�����
 * ������������Ӧ�������û�����
 */
async function shutdownServer() {
    // ȷ�϶Ի���
    if (!confirm('��ȷ��Ҫ�رշ������𣿹رպ������û����޷����ʣ���Ҫ�����������������ܼ���ʹ�á�')) return;
    
    // ��������ģ̬��HTML
    const modalHtml = `...`;
    
    // ����ģ̬�����������ӵ�ҳ��
    const modalContainer = document.createElement('div');
    modalContainer.id = 'shutdownModalContainer';
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);
    
    try {
        // ���ʹ�JWT Token�Ĺر�����
        const response = await fetch('/api/shutdown', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // ������Ӧ...
    } catch (err) {
        // �����������...
    }
}

// ����������hideShutdownModal, updateShutdownMessage, updateShutdownProgress, updateShutdownDetails
```

**�����ص�**��
- �û��Ѻõ�ȷ�϶Ի���
- ����ָʾ������������״̬��Ϣ��
- 5��ģ��رչ��̣���ʾ�𲽽���
- �����ɹ���Ӧ���������
- �ṩ�û�����ѡ��������ӡ��رձ�ǩҳ�������鿴

#### 2. ����޸� (`server.js`)
�޸� `/api/shutdown` ·�ɣ�

```javascript
// ����JWT��֤�м��
const { authenticate } = require('./src/middleware/auth');

// ��ȫ�ػ��˵㣨��ҪJWT��֤��
app.post('/api/shutdown', authenticate, (req, res) => {
    const clientIP = req.ip || req.connection.remoteAddress;
    const userId = req.user?.id || 'δ֪�û�';
    const username = req.user?.username || 'δ֪�û���';
    
    console.log(`���յ��ػ������û�ID: ${userId} (${username}), IP: ${clientIP}`);
    console.log('���ڱ�������...');
    
    try {
        saveDatabase();
    } catch (err) {
        console.error('�������ݿ�ʧ��:', err.message);
        return res.status(500).json({ error: '�������ݿ�ʧ��' });
    }
    
    res.json({ 
        message: '�ػ������ѽ���',
        userId,
        username,
        timestamp: new Date().toISOString()
    });
    
    // �ӳ�500�����رշ�����
    setTimeout(() => {
        console.log(`�û� ${username} ������رշ����������ڹر�...`);
        server.close(() => {
            console.log('�������ѹر�');
            process.exit(0);
        });
    }, 500);
});
```

**�Ľ���**��
- ����JWT��֤�м����ȷ��ֻ�е�¼�û��ɵ���
- �Ƴ����ޱ���IP�����ƣ������������������豸����
- ��¼�û���Ϣ��IP��ַ���������
- ���õĴ����������ݿⱣ��ʧ�ܣ�
- ����ϸ����Ӧ��Ϣ

## ������֤

### ���Ի���
- Windows 10/11
- Node.js v18+
- �˿ڣ�3000
- �����û���test0 (id=1)

### ���Բ���

1. **���ɲ���Token**��
   ```bash
   node generate_token.js
   ```
   �����`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

2. **��֤����������״̬**��
   ```bash
   curl http://localhost:3000/health
   ```
   ��Ӧ��`{"status":"ok","timestamp":"...","service":"finance-management-system","uptime":...}`

3. **���Թر�API**��
   ```bash
   curl -X POST -H "Authorization: Bearer <TOKEN>" -H "Content-Type: application/json" http://localhost:3000/api/shutdown -v
   ```
   ��Ӧ��`{"message":"�ػ������ѽ���","userId":1,"username":"test0","timestamp":"..."}`

4. **��֤�������ر�**��
   ```bash
   netstat -ano | findstr :3000
   ```
   ȷ�϶˿�3000���ٱ�ռ��

### ǰ�˹��ܲ���
1. ������������`start.bat`
2. ���� `http://localhost:3000`
3. ʹ�� test0/test0 ��¼
4. ������Ͻ��û��� �� "�رշ�����"
5. �۲�ȷ�϶Ի��� �� ����ģ̬�� �� �رչ��� �� ����״̬

## ����Ҫ��

### 1. ǰ���ͨ��
- ǰ�˷��� `POST /api/shutdown` ����
- Я�� `Authorization: Bearer <JWT_TOKEN>` ͷ
- �����֤Token����ȡ�û���Ϣ

### 2. ����ָʾʵ��
- ʹ��Bootstrapģ̬��ͽ��������
- JavaScript��ʱ��ģ���������
- 5��رչ����ṩʵʱ����

### 3. ������
- ���������ʾ"�������������жϣ������ѳɹ��ر�"
- API������ʾ���������صĴ�����Ϣ
- �û�ȡ��������ģ̬��

### 4. ��ȫ����
- JWT��֤ȷ��ֻ�е�¼�û��ɹرշ�����
- ��¼�û���Ϣ��IP��ַ�������
- �Ƴ�IP���ƺ��Ա��ְ�ȫ��

## �ĵ�����

### README.md ����
��"���Źر������ݱ���"�½������ˣ�
1. ǰ�˹رշ�����������ϸ˵��
2. API�رսӿڹ淶����֤Ҫ��
3. ����ʵ��ϸ��
4. ���ϻָ�����

### �û�ָ�Ͻ���
�������û�ָ�������ӣ�
1. �رշ������Ĳ�������
2. �رչ����е�״̬˵��
3. �رպ�Ĳ���ѡ��

## ���������Ľ�

### 1. ����淶
- ���������ı�ʹ��UTF-8����
- ��������JSDocע��˵��
- ������ʹ��try-catch�ṹ

### 2. ��ά����
- ���رչ�����غ���������һ��
- ��������ְ��һ
- �����ĺ��������Ͳ���˵��

### 3. ����չ��
- ǰ�˹رչ��ܿ��������Ӹ���״̬
- ��˹ر�·�ɿ���չ������־��¼��֪ͨ�ȹ���

## ��֪���ƺ�δ���Ľ�

### ��ǰ����
1. ǰ��ģ����Ȳ�����ʵ�رս���
2. �رպ��޷��Զ�����������
3. ���û�ͬʱ����ʱ�رջ�Ӱ�������û�

### ����Ľ�
1. **��ʵ���ȷ���**����˿��ṩ�رս׶�״̬
2. **�ر�ȷ�ϻ���**����Ҫ����Աȷ�ϻ�������֤
3. **����֪ͨ**���ر�ǰ֪ͨ���������û�
4. **�ƻ��ر�**��֧�ֶ�ʱ�رշ�����

## �ܽ�

�����޸��ɹ������"ǰ�˵���رշ������޷�Ӧ"�����⣬ʵ���ˣ�

1. **����������**��ǰ�˹رհ�ť������������
2. **�û�����**���ṩ�ѺõĽ���ָʾ��״̬����
3. **��ȫ��**��ʹ��JWT��֤ȷ��ֻ����Ȩ�û��ɹرշ�����
4. **�ɿ���**��ȷ�����ݿ��ڹر�ǰ��ȷ����
5. **��ά����**������ṹ���������ں�����չ

�޸����ϵͳ�����û�����"Ԥ���Ч��Ӧ���ǹرշ���������ʾ�û��������Ѿ��ر�"���ṩ�������Ĺر����̺��û��������ơ>
